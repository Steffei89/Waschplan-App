rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HILFSFUNKTIONEN (Die "Ausweis-Kontrolle") ---
    
    // Prüft, ob User eingeloggt ist
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Holt die Daten des aktuellen Nutzers aus der Datenbank
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Prüft, ob der Nutzer Admin ist
    function isAdmin() {
      return isSignedIn() && getUserData().isAdmin == true;
    }
    
    // Prüft, ob der Nutzer zur angegebenen Partei gehört
    // WICHTIG: Das verhindert, dass man für andere bucht!
    function isMemberOf(parteiName) {
      return isSignedIn() && getUserData().partei == parteiName;
    }

    // --- REGELN FÜR DIE SAMMLUNGEN ---

    // 1. Parteien & Karma
    match /parties/{parteiName} {
      allow read: if isSignedIn();
      // Nur Mitglieder der Partei dürfen ihr Karma ändern (oder Admin)
      allow write: if isMemberOf(parteiName) || isAdmin();
    }

    // 2. Benutzerprofile
    match /users/{userId} {
      allow read: if isSignedIn();
      
      // Erstellen nur mit korrektem Invite-Code "FamRei2025"
      allow create: if isSignedIn() 
                    && request.auth.uid == userId
                    && request.resource.data.inviteCode == "FamRei2025";
                    
      // Löschen darf nur der Admin oder der Nutzer selbst
      allow delete: if (isSignedIn() && request.auth.uid == userId) || isAdmin();
      
      // Update-Regeln (Streng!)
      allow update: if isAdmin() || (
        isSignedIn() && request.auth.uid == userId &&
        request.resource.data.isAdmin == resource.data.isAdmin && // Darf sich selbst nicht zum Admin machen
        (
          // Partei darf nur gesetzt werden, wenn sie vorher LEER war (Initiale Einrichtung)
          (resource.data.partei == null || resource.data.partei == "") ||
          // Oder wenn sie gleich bleibt
          (request.resource.data.partei == resource.data.partei)
        )
      );
    }

    // 3. Buchungen (Hier war die größte Lücke!)
    match /bookings/{docId} {
      allow read: if isSignedIn();
      
      // Erstellen: Nur erlaubt, wenn man für SEINE EIGENE Partei bucht!
      allow create: if isAdmin() || (
        isSignedIn() && 
        isMemberOf(request.resource.data.partei)
      );
      
      // Bearbeiten (z.B. Check-in): Nur eigene Partei oder Admin
      allow update: if isAdmin() || (
        isSignedIn() && 
        isMemberOf(resource.data.partei)
      );
      
      // Löschen: Nur EIGENE Buchungen löschen erlaubt!
      allow delete: if isAdmin() || (
        isSignedIn() && 
        isMemberOf(resource.data.partei)
      );
    }

    // 4. Tauschanfragen
    match /swap_requests/{docId} {
      allow read, write: if isSignedIn();
    }

    // 5. App-Einstellungen (Wetter PLZ, QR Code)
    match /app_settings/config {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
    
    // 6. Sperrungen / Wartung
    match /blocked_slots/{blockId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // 7. Timer Programme
    match /wash_programs/{programId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
    match /active_timers/{partei} {
      // Timer darf nur von der betroffenen Partei oder Admin gesetzt werden
      allow read, write: if isMemberOf(partei) || isAdmin();
    }
    
    // 8. Statistik & Analytics
    match /usage_stats/{docId} {
      allow read, write: if isSignedIn();
    }
    match /analytics_sessions/{docId} {
      allow create, update: if isSignedIn();
      allow read: if isAdmin();
    }
    match /analytics_games/{docId} {
      allow create: if isSignedIn();
      allow read: if isAdmin();
    }

    // 9. Minigame Highscores
    match /minigame_scores/{docId} {
      allow read, write: if isSignedIn();
      match /history/{historyId} {
         allow read, write: if isSignedIn();
      }
    }
    
    // 10. Wartungstickets (Tickets melden)
    match /maintenance_tickets/{ticketId} {
      // Jeder darf ein Ticket erstellen
      allow create: if isSignedIn();
      // Lesen/Update/Löschen darf nur der Admin (verhindert Manipulation durch Nutzer)
      allow read, update, delete: if isAdmin();
    }
  }
}