rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================
    // üõ† HELFER-FUNKTIONEN (Sicherheit & Lesbarkeit)
    // ============================================================
    
    // Pr√ºft, ob der Nutzer eingeloggt ist
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Pr√ºft, ob der Nutzer der Admin ist (Feld 'isAdmin' im User-Profil)
    function isAdmin() {
      return isSignedIn() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }
    
    // Pr√ºft, ob der Nutzer zu einer bestimmten Partei geh√∂rt
    function isParteiMitglied(parteiName) {
      return isSignedIn() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.partei == parteiName;
    }

    // ============================================================
    // üè† KARMA-SYSTEM (PARTIES)
    // ============================================================
    match /parties/{parteiName} {
      // Lesen: Jeder
      allow read: if isSignedIn();
      
      // Schreiben: Nur Mitglieder der Partei (f√ºr Auto-Update) oder Admin
      allow write: if isParteiMitglied(parteiName) || isAdmin();
    }

    // ============================================================
    // üë§ BENUTZERPROFILE
    // ============================================================
    match /users/{userId} {
      allow read: if isSignedIn();
      
      // Erstellen: Nur das eigene Profil bei der Registrierung
      allow create: if isSignedIn() && request.auth.uid == userId;
      
      // L√∂schen: Nur man selbst oder Admin
      allow delete: if (isSignedIn() && request.auth.uid == userId) || isAdmin();
      
      // Update: Admin darf alles. Nutzer darf eigenes Profil √§ndern, 
      // ABER: Admin-Status und Partei d√ºrfen nicht gef√§lscht werden!
      allow update: if isAdmin() || (
        isSignedIn() && request.auth.uid == userId &&
        // Sicherheits-Check: Darf isAdmin oder partei nicht √§ndern
        request.resource.data.isAdmin == resource.data.isAdmin &&
        request.resource.data.partei == resource.data.partei 
      );
    }

    // ============================================================
    // üìÖ BUCHUNGEN (Sicherheits-Upgrade!)
    // ============================================================
    match /bookings/{docId} {
      // Lesen & Erstellen: Jeder eingeloggte Nutzer
      allow read, create: if isSignedIn();
      
      // Bearbeiten (z.B. Check-in/Check-out): Nutzer der Partei oder Admin
      allow update: if isSignedIn() && (
        resource.data.partei == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.partei ||
        isAdmin()
      );

      // L√∂schen: Nur der Ersteller, die Partei oder der Admin!
      // (Verhindert, dass Fremde deine Buchung l√∂schen)
      allow delete: if isSignedIn() && (
        resource.data.userId == request.auth.uid || 
        resource.data.partei == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.partei ||
        isAdmin()
      );
    }

    // ============================================================
    // üîÑ TAUSCHANFRAGEN
    // ============================================================
    match /swap_requests/{docId} {
      allow read, write: if isSignedIn();
    }

    // ============================================================
    // ‚öôÔ∏è APP-EINSTELLUNGEN (Wetter PLZ, QR Code)
    // ============================================================
    match /app_settings/config {
      // Lesen: Jeder (f√ºr Wetter & QR-Check)
      allow read: if isSignedIn();
      // Schreiben: Nur Admin
      allow write: if isAdmin();
    }
    
    // ============================================================
    // üö´ SPERRUNGEN
    // ============================================================
    match /blocked_slots/{blockId} {
      allow read: if isSignedIn();
      allow create, delete: if isAdmin();
    }

    // ============================================================
    // ‚è±Ô∏è TIMER (Programme & Aktive Timer)
    // ============================================================
    match /wash_programs/{programId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    match /active_timers/{partei} {
      // Jeder der Partei darf Timer starten/stoppen
      allow read, write: if isParteiMitglied(partei) || isAdmin();
    }
    
    // ============================================================
    // üìä STATISTIK & ANALYTICS
    // ============================================================
    match /usage_stats/{docId} {
      allow read, write: if isSignedIn();
    }
    
    match /analytics_sessions/{docId} {
      allow create, update: if isSignedIn();
      allow read: if isAdmin();
    }

    match /analytics_games/{docId} {
      allow create: if isSignedIn();
      allow read: if isAdmin();
    }

    // ============================================================
    // üéÆ MINIGAME & HIGHSCORES (Fehler bereinigt)
    // ============================================================
    match /minigame_scores/{docId} {
      // Haupt-Score (Partei)
      allow read, write: if isSignedIn();

      // Unter-Sammlung "history" (Wichtig f√ºr Verlauf!)
      match /history/{historyId} {
         allow read, write: if isSignedIn();
      }
    }
    
    // ============================================================
    // üõ† WARTUNG & TICKETS
    // ============================================================
    match /maintenance_tickets/{ticketId} {
      // Erstellen: Jeder Nutzer
      allow create: if isSignedIn();
      // Lesen/Bearbeiten: Nur Admin
      allow read, update, delete: if isAdmin();
    }

  }
}