rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ğŸ›  HELFER-FUNKTIONEN
    function isSignedIn() {
      return request.auth != null;
    }
    function isAdmin() {
      return isSignedIn() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }
    function isParteiMitglied(parteiName) {
      return isSignedIn() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.partei == parteiName;
    }

    // ğŸ  KARMA-SYSTEM
    match /parties/{parteiName} {
      allow read: if isSignedIn();
      allow write: if isParteiMitglied(parteiName) || isAdmin();
    }

    // ğŸ‘¤ BENUTZERPROFILE
    match /users/{userId} {
      allow read: if isSignedIn();
      
      // Erstellen: Nur mit korrektem Invite-Code! (Partei ist hier noch optional)
      allow create: if isSignedIn() 
                    && request.auth.uid == userId
                    && request.resource.data.inviteCode == "FamRei2025";
      
      allow delete: if (isSignedIn() && request.auth.uid == userId) || isAdmin();
      
      // Update: Admin darf alles.
      // Nutzer darf Profil Ã¤ndern, ABER:
      // 1. Admin-Status darf nicht geÃ¤ndert werden.
      // 2. Partei darf NUR geÃ¤ndert werden, wenn sie vorher noch NICHT gesetzt war (Erste Einrichtung).
      allow update: if isAdmin() || (
        isSignedIn() && request.auth.uid == userId &&
        request.resource.data.isAdmin == resource.data.isAdmin &&
        (
          // Fall A: Partei ist schon gesetzt -> darf nicht geÃ¤ndert werden (muss gleich bleiben)
          (resource.data.partei != null && resource.data.partei != "" && request.resource.data.partei == resource.data.partei)
          ||
          // Fall B: Partei war noch leer -> darf jetzt gesetzt werden (Erste Einrichtung)
          (resource.data.partei == null || resource.data.partei == "")
        )
      );
    }

    // ğŸ“… BUCHUNGEN
    match /bookings/{docId} {
      allow read, create: if isSignedIn();
      allow update: if isSignedIn() && (
        resource.data.partei == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.partei ||
        isAdmin()
      );
      allow delete: if isSignedIn() && (
        resource.data.userId == request.auth.uid || 
        resource.data.partei == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.partei ||
        isAdmin()
      );
    }

    // ğŸ”„ TAUSCHANFRAGEN
    match /swap_requests/{docId} {
      allow read, write: if isSignedIn();
    }

    // âš™ï¸ APP-EINSTELLUNGEN
    match /app_settings/config {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
    
    // ğŸš« SPERRUNGEN
    match /blocked_slots/{blockId} {
      allow read: if isSignedIn();
      allow create, delete: if isAdmin();
    }

    // â±ï¸ TIMER
    match /wash_programs/{programId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
    match /active_timers/{partei} {
      allow read, write: if isParteiMitglied(partei) || isAdmin();
    }
    
    // ğŸ“Š STATISTIK & ANALYTICS
    match /usage_stats/{docId} {
      allow read, write: if isSignedIn();
    }
    match /analytics_sessions/{docId} {
      allow create, update: if isSignedIn();
      allow read: if isAdmin();
    }
    match /analytics_games/{docId} {
      allow create: if isSignedIn();
      allow read: if isAdmin();
    }

    // ğŸ® MINIGAME
    match /minigame_scores/{docId} {
      allow read, write: if isSignedIn();
      match /history/{historyId} {
         allow read, write: if isSignedIn();
      }
    }
    
    // ğŸ›  WARTUNG
    match /maintenance_tickets/{ticketId} {
      allow create: if isSignedIn();
      allow read, update, delete: if isAdmin();
    }
  }
}